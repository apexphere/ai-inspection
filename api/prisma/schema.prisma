// AI Inspection Database Schema
// See: docs/design/002-backend-service-architecture.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Authentication — Issue #181
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  passwordHash  String
  phoneNumber   String?   @unique
  phoneVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  passwordResetTokens      PasswordResetToken[]
  whatsappVerificationCodes WhatsAppVerificationCode[]
  
  @@index([email])
  @@index([phoneNumber])
}

// Password reset tokens — Issue #182
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([userId])
}

// WhatsApp verification codes — Issue #189
model WhatsAppVerificationCode {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneNumber String
  code        String
  expiresAt   DateTime
  verifiedAt  DateTime?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([phoneNumber, code])
}

model Inspection {
  id            String    @id @default(uuid())
  address       String
  clientName    String
  inspectorName String?
  checklistId   String
  status        Status    @default(STARTED)
  currentSection String
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?
  
  findings      Finding[]
  reports       Report[]
}

model Finding {
  id            String    @id @default(uuid())
  inspectionId  String
  inspection    Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  section       String
  text          String
  severity      Severity  @default(INFO)
  matchedComment String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  photos        Photo[]
}

model Photo {
  id          String   @id @default(uuid())
  findingId   String
  finding     Finding  @relation(fields: [findingId], references: [id], onDelete: Cascade)
  filename    String
  path        String
  mimeType    String
  createdAt   DateTime @default(now())
}

model Report {
  id            String    @id @default(uuid())
  inspectionId  String
  inspection    Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  format        String    @default("pdf")
  path          String
  createdAt     DateTime  @default(now())
}

enum Status {
  STARTED
  IN_PROGRESS
  COMPLETED
}

enum Severity {
  INFO
  MINOR
  MAJOR
  URGENT
}

// ============================================
// Project Management Entities
// ============================================

model Project {
  id          String        @id @default(uuid())
  jobNumber   String        @unique
  activity    String
  reportType  ReportType
  status      ProjectStatus @default(DRAFT)
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id])
  clientId    String
  client      Client        @relation(fields: [clientId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  siteInspections SiteInspection[]
  documents       Document[]
  photos          ProjectPhoto[]
}

model Property {
  id                   String               @id @default(uuid())
  streetAddress        String
  suburb               String?
  city                 String?
  postcode             String?
  lotDp                String?
  councilPropertyId    String?
  territorialAuthority TerritorialAuthority
  bcNumber             String?
  yearBuilt            Int?
  siteData             Json?
  construction         Json?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  projects             Project[]
  buildingHistory      BuildingHistory[]
}

model Client {
  id            String    @id @default(uuid())
  name          String
  email         String?
  phone         String?
  mobile        String?
  address       String?
  contactPerson String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  projects      Project[]
}

enum ReportType {
  COA
  CCC_GAP
  PPI
  SAFE_SANITARY
  TFA
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  REVIEW
  COMPLETED
}

enum TerritorialAuthority {
  AKL
  WCC
  CCC
  HDC
  TCC
  DCC
  HCC
  PCC
  NCC
  ICC
  NPDC
  WDC
  RDC
  OTHER
}

// ============================================
// Site Inspection Entities
// ============================================

model SiteInspection {
  id                String              @id @default(uuid())
  projectId         String
  project           Project             @relation(fields: [projectId], references: [id])
  
  type              InspectionType
  stage             InspectionStage
  date              DateTime
  status            InspectionStatus    @default(DRAFT)
  
  // Context
  weather           String?
  personsPresent    String?
  equipment         String[]            @default([])
  methodology       String?
  areasNotAccessed  String?
  
  // Inspector (string for now, will reference Personnel later)
  inspectorName     String
  
  // LBP Verification (Simple mode)
  lbpOnSite         Boolean?
  lbpLicenseSighted Boolean?
  lbpLicenseNumber  String?
  lbpExpiryDate     DateTime?
  
  // Outcome
  outcome           InspectionOutcome?
  signatureData     String?
  signatureDate     DateTime?
  
  // WhatsApp navigation
  currentSection    String?
  currentClauseId   String?
  
  // Soft delete
  deletedAt         DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  checklistItems    ChecklistItem[]
  clauseReviews     ClauseReview[]
  measurements      SiteMeasurement[]
  
  @@index([projectId])
  @@index([status])
}

// Site measurement records
model SiteMeasurement {
  id              String              @id @default(uuid())
  inspectionId    String
  inspection      SiteInspection      @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  type            MeasurementType
  location        String
  value           Float
  unit            MeasurementUnit
  result          MeasurementResult   @default(PENDING)
  
  linkedClauseId  String?
  linkedClause    BuildingCodeClause? @relation(fields: [linkedClauseId], references: [id])
  
  notes           String?
  
  sortOrder       Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([inspectionId])
  @@index([type])
}

enum MeasurementType {
  MOISTURE_CONTENT
  SLOPE_FALL
  DIMENSION
  CLEARANCE
  TEMPERATURE
  OTHER
}

enum MeasurementUnit {
  PERCENT         // %
  MM_PER_M        // mm/m (slope)
  MM              // mm
  CM              // cm
  M               // m
  CELSIUS         // °C
}

enum MeasurementResult {
  PENDING
  PASS
  FAIL
}

model ChecklistItem {
  id              String          @id @default(uuid())
  inspectionId    String
  inspection      SiteInspection  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  category        ChecklistCategory
  item            String
  decision        Decision
  notes           String?
  
  photoIds        String[]        @default([])
  
  sortOrder       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([inspectionId, category])
}

enum ChecklistCategory {
  EXTERIOR
  INTERIOR
  DECKS
  SERVICES
  SITE
}

enum Decision {
  PASS
  FAIL
  NA
}

enum InspectionType {
  SIMPLE
  CLAUSE_REVIEW
}

enum InspectionStage {
  INS_01
  INS_02
  INS_03
  INS_04
  INS_05
  INS_06
  INS_07
  INS_07A
  INS_08
  INS_09
  INS_10
  INS_11
  COA
  CCC_GA
  S_AND_S
  TFA
  DMG
}

enum InspectionStatus {
  DRAFT
  IN_PROGRESS
  REVIEW
  COMPLETED
}

enum InspectionOutcome {
  PASS
  FAIL
  REPEAT_REQUIRED
}

// ============================================
// Building Code Reference Data
// ============================================

model BuildingCodeClause {
  id                String              @id @default(uuid())
  code              String              @unique
  title             String
  category          ClauseCategory
  objective         String?
  functionalReq     String?
  performanceText   String
  durabilityPeriod  DurabilityPeriod?
  typicalEvidence   String[]            @default([])
  sortOrder         Int                 @default(0)
  
  parentId          String?
  parent            BuildingCodeClause? @relation("ClauseHierarchy", fields: [parentId], references: [id])
  children          BuildingCodeClause[] @relation("ClauseHierarchy")
  
  clauseReviews     ClauseReview[]
  measurements      SiteMeasurement[]
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([category])
  @@index([parentId])
}

enum ClauseCategory {
  B
  C
  D
  E
  F
  G
  H
}

enum DurabilityPeriod {
  FIFTY_YEARS
  FIFTEEN_YEARS
  FIVE_YEARS
  NA
}

// ============================================
// Clause Review (for COA/CCC inspections)
// ============================================

model ClauseReview {
  id              String              @id @default(uuid())
  inspectionId    String
  inspection      SiteInspection      @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  
  clauseId        String
  clause          BuildingCodeClause  @relation(fields: [clauseId], references: [id])
  
  applicability   Applicability
  naReason        String?
  observations    String?
  
  photoIds        String[]            @default([])
  docIds          String[]            @default([])
  
  docsRequired    String?
  remedialWorks   String?
  
  sortOrder       Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@unique([inspectionId, clauseId])
  @@index([inspectionId])
}

enum Applicability {
  APPLICABLE
  NA
}

// ============================================
// Photo Attachments (Issue #172)
// ============================================

model ProjectPhoto {
  id              String        @id @default(uuid())
  projectId       String
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  inspectionId    String?       // Which inspection captured it
  
  reportNumber    Int           // Sequential within project (1, 2, 3...)
  filePath        String        // Storage path to original
  thumbnailPath   String?       // Compressed preview
  mimeType        String        @default("image/jpeg")
  fileSize        Int?          // Bytes
  
  caption         String
  source          PhotoSource   @default(SITE)
  takenAt         DateTime?     // When photo was taken
  location        Json?         // GPS coordinates
  
  linkedClauses   String[]      @default([])  // Building Code clause codes
  
  sortOrder       Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([projectId])
  @@index([projectId, reportNumber])
}

enum PhotoSource {
  SITE        // Taken during inspection
  OWNER       // Client provided
  CONTRACTOR  // Builder/trade provided
}

// ============================================
// N/A Reason Templates (reference data)
// ============================================

model NAReasonTemplate {
  id          String   @id @default(uuid())
  template    String
  usage       String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// Document Management
// ============================================

model Document {
  id              String          @id @default(uuid())
  projectId       String
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  appendixLetter  String?
  filePath        String
  filename        String
  documentType    DocumentType
  description     String
  
  issuer          String?
  issuedAt        DateTime?
  referenceNumber String?
  
  status          DocumentStatus  @default(REQUIRED)
  verified        Boolean         @default(false)
  linkedClauses   String[]        @default([])
  
  sortOrder       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([projectId])
  @@index([documentType])
  @@index([status])
}

enum DocumentType {
  PS1
  PS2
  PS3
  PS4
  COC
  ESC
  WARRANTY
  INVOICE
  DRAWING
  REPORT
  FLOOD_TEST
  PROPERTY_FILE
  OTHER
}

enum DocumentStatus {
  REQUIRED
  RECEIVED
  OUTSTANDING
  NA
}

// Building permit/consent history
model BuildingHistory {
  id          String              @id @default(uuid())
  propertyId  String
  property    Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  type        BuildingHistoryType
  reference   String
  year        Int
  status      BuildingHistoryStatus @default(UNKNOWN)
  description String?
  issuer      String?
  issuedAt    DateTime?
  
  sortOrder   Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  @@index([propertyId])
  @@index([type])
}

enum BuildingHistoryType {
  BUILDING_PERMIT
  BUILDING_CONSENT
  CCC
  COA
  RESOURCE_CONSENT
  OTHER
}

enum BuildingHistoryStatus {
  ISSUED
  LAPSED
  CANCELLED
  COMPLETE
  UNKNOWN
}
